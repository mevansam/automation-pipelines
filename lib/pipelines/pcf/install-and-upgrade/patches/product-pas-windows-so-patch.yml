- type: replace
  path: /resources/-
  value:
    name: pas-windows-tile
    type: s3
    source:
      bucket: pcf
      endpoint: ((autos3_url))
      access_key_id: ((autos3_access_key))
      secret_access_key: ((autos3_secret_key))
      regexp: downloads/${product_slug}_(.*).tgz

- type: replace
  path: /jobs/-
  value:
    name: upload-pas-windows-tile
    on_failure:
      do:
      - task: notify on upload-pas-windows-tile failure
    
    serial: true
    plan:
    - aggregate:
      - get: automation
      - get: pivnet-download
        resource: pas-windows-tile
        trigger: true

    # Wait for director to be in a ready state
    - task: wait-for-director-to-be-ready
      file: automation/lib/inceptor/tasks/wait-for-state/task.yml
      params: 
        WAIT_FOR_STATE: director_ready
        AUTOS3_URL: ((autos3_url))
        AUTOS3_ACCESS_KEY: ((autos3_access_key))
        AUTOS3_SECRET_KEY: ((autos3_secret_key))

    # Inject root file system
    - task: inject-windows-rootfs
      config:
        platform: linux
        image_resource:
          type: docker-image
          source:
            repository: appbricks/tools
        inputs:
        - name: automation
        - name: pivnet-download
        outputs:
        - name: pivnet-download-updated
        run:
          path: /bin/sh
          args:
          - -c
          - |
            pwd
            mkdir injector-workspace
            PATH_TO_TAR=`find ./pivnet-download -name *windows.tgz`
            echo "PATH TO TAR $PATH_TO_TAR"
            tar -xf $PATH_TO_TAR -C injector-workspace
            PATH_TO_INJECTOR_ZIP=`find ./injector-workspace/pivnet-product/ -name winfs-injector-*`
            echo "PATH TO ZIP $PATH_TO_INJECTOR_ZIP"
            unzip $PATH_TO_INJECTOR_ZIP -d injector-workspace/pivnet-product/
            chmod +x injector-workspace/pivnet-product/winfs-injector-linux
            PATH_TO_TILE=`find ./injector-workspace/pivnet-product/ -name *.pivotal`
            echo "PATH TO tile $PATH_TO_TILE"
            ./injector-workspace/pivnet-product/winfs-injector-linux --input-tile=$PATH_TO_TILE --output-tile=pivnet-download-updated/injected-tile.pivotal
            ##COPY STEMCELL
            PATH_TO_STEMCELL=`find ./pivnet-download -name *go_agent.tgz`
            cp $PATH_TO_STEMCELL pivnet-download-updated/windows-stemcell.tgz

      
    # Upload product tile and its stemcell
    - task: upload-tile
      file: automation/lib/tasks/opsman/upload-product-and-stemcell/task.yml
      input_mapping:
        pivnet-download: pivnet-download-updated
      params:
        OPSMAN_HOST: ((opsman_host))
        OPSMAN_CLIENT_ID: ((opsman_client_id))
        OPSMAN_CLIENT_SECRET: ((opsman_client_secret))
        OPSMAN_USERNAME: ((opsman_admin_username))
        OPSMAN_PASSWORD: ((opsman_admin_password))

    # This task will block if the environment 
    # has been put into stopped state
    # - task: wait-until-started
    #   file: automation/lib/inceptor/tasks/wait-for-state/task.yml
    #   params: 
    #     WAIT_FOR_STATE: started
    #     AUTOS3_URL: ((autos3_url))
    #     AUTOS3_ACCESS_KEY: ((autos3_access_key))
    #     AUTOS3_SECRET_KEY: ((autos3_secret_key))

    # Stage and apply changes
    # - task: stage-and-apply-tile
    #   file: automation/lib/tasks/opsman/stage-product/task.yml
    #   params:
    #     OPSMAN_HOST: ((opsman_host))
    #     OPSMAN_CLIENT_ID: ((opsman_client_id))
    #     OPSMAN_CLIENT_SECRET: ((opsman_client_secret))
    #     OPSMAN_USERNAME: ((opsman_admin_username))
    #     OPSMAN_PASSWORD: ((opsman_admin_password))
    #     STAGE_AND_APPLY: true
    #     ENABLE_ERRANDS: ((enable_errands))

- type: replace
  path: /groups/name=Install and Upgrade Products/jobs?/0:before
  value: upload-pas-windows-tile
